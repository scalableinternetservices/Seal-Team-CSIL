<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

<h1 class='center'> Hello, you have reached the home page! </h1>

<!-- <div style='width: 1000px;'>
  <div id="map" style='width: 1000px; height: 400px; background-position: center;'></div>
</div> -->
<div class="map_container">
  <div id="map_canvas" class="map_canvas"></div>
</div>
<script type="text/javascript">

    function getViewerLocation(){
        <% if @lat.present? && @lng.present?%>
            console.log("cached");
            var mapOptions = {
                center: new google.maps.LatLng(<%= @lat %>, <%= @lng %>),
                zoom: 16};
            initMap(mapOptions);
        <% else %>
            console.log('not cached');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var mapOptions = {
                        center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                        zoom: 16};
                    console.log("got location");
                    $.ajax({
                        url: "graph/save_user_location",
                        type: "POST",
                        data: {lat: position.coords.latitude, lng: position.coords.longitude}
                    });
                    console.log("sent location");
                    initMap(mapOptions)
                });
            }
            else {alert("Please use a browser that supports HTML5")}
        <% end %>
    }
    function getMarkers(lat, lng){
        return $.ajax({
            url: "graph/load_local_deals",
            type: "GET",
            data: {lat: lat, lng: lng},
            dataType: 'json'
        });
    }
    function initMap(mapOptions) {
        console.log("building map");
        handler = Gmaps.build('Google');
        handler.buildMap({ provider: mapOptions, internal: {id: 'map_canvas'}}, function(){
            getMarkers(handler.getMap().getCenter().A, handler.getMap().getCenter().F).done(function(result) {
                console.log(result);
               handler.addMarkers(result)
            });
            google.maps.event.addListener(handler.getMap(), 'idle', function() {
                console.log(handler.getMap().getCenter());
                getMarkers(handler.getMap().getCenter().A, handler.getMap().getCenter().F).done(function (result) {
                    console.log(result);
                    handler.addMarkers(result)
                });
            });
        });
    }


    getViewerLocation();
</script>
